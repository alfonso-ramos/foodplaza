package asedi.controllers.gerencia;

import java.io.File;
import java.io.IOException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.ResourceBundle;
import java.util.WeakHashMap;
import java.util.function.Predicate;
import java.util.stream.Collectors;

import asedi.model.Menu;
import asedi.model.Producto;
import asedi.model.Usuario;
import asedi.services.AuthService;
import asedi.services.MenuService;
import asedi.services.ProductoService;
import asedi.utils.AlertUtils;
import javafx.application.Platform;
import javafx.beans.property.BooleanProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.concurrent.Task;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.fxml.Initializable;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.HBox;
import javafx.scene.layout.StackPane;
import javafx.scene.text.Text;
import javafx.stage.FileChooser;
import javafx.stage.Modality;
import javafx.stage.Stage;

public class ProductoController implements Initializable {

    // Componentes de la interfaz
    @FXML private TableView<Producto> tblProductos;
    @FXML private TableColumn<Producto, String> colNombre;
    @FXML private TableColumn<Producto, String> colDescripcion;
    @FXML private TableColumn<Producto, Number> colPrecio;
    @FXML private TableColumn<Producto, String> colCategoria;
    @FXML private TableColumn<Producto, Boolean> colDisponible;
    @FXML private TableColumn<Producto, Void> colAcciones;
    
    // Campos del formulario
    @FXML private TextField txtBuscar;
    @FXML private ComboBox<Menu> cmbMenu;
    @FXML private Label lblPagina;
    @FXML private StackPane loadingPane;
    @FXML private Text txtTitulo;
    @FXML private TextField txtNombre;
    @FXML private TextArea txtDescripcion;
    @FXML private TextField txtPrecio;
    @FXML private TextField txtStock;
    @FXML private ImageView imgVistaPrevia;
    @FXML private Label lblNombreArchivo;
    @FXML private TextField txtImagenUrl;
    @FXML private TextField txtImagenPublicId;
    @FXML private Label lblErrorNombre;
    @FXML private Label lblErrorDescripcion;
    @FXML private Label lblErrorPrecio;
    @FXML private Label lblErrorStock;
    @FXML private Label lblErrorImagen;
    @FXML private CheckBox chkDisponible;
    @FXML private ComboBox<String> cmbCategoria;
    
    // Inyectar dependencias
    private final ProductoService productoService;
    
    private final ObservableList<Producto> productos = FXCollections.observableArrayList();
    private final int ITEMS_POR_PAGINA = 20;
    private int paginaActual = 0;
    private int totalProductos = 0;
    
    // Cache para imágenes
    private final Map<String, Image> imageCache = new WeakHashMap<>();
    private Long menuId; // ID del menú actual, si es que se está viendo un menú específico
    private final MenuService menuService = new MenuService();
    private File imagenSeleccionada = null;
    
    public ProductoController() {
        this.productoService = new ProductoService();
    }
}
    
    /**
     * Establece el ID del menú del cual se mostrarán los productos.
     * Si es null, se mostrarán todos los productos.
     */
    public void setMenuId(Long menuId) {
        this.menuId = menuId;
    }
}
    
    @FXML
    private void handleAgregarProducto(ActionEvent event) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/views/gerencia/productos/formulario_producto.fxml"));
            Parent root = loader.load();
            
            // Obtener el controlador y configurar el título
            ProductoController controller = loader.getController();
            controller.configurarParaNuevoProducto();
            
            Stage stage = new Stage();
            stage.setScene(new Scene(root));
            stage.setTitle("Nuevo Producto");
            stage.initModality(Modality.APPLICATION_MODAL);
            stage.showAndWait();
            
            cargarProductos();
        } catch (IOException e) {
            e.printStackTrace();
            mostrarError("Error", "No se pudo cargar el formulario de producto");
        }
}
    }
}
    
    public void configurarParaNuevoProducto() {
        // Limpiar campos
        txtTitulo.setText("Nuevo Producto");
        txtNombre.clear();
        txtDescripcion.clear();
        txtPrecio.clear();
        txtStock.clear();
        chkDisponible.setSelected(true);
        cmbCategoria.getSelectionModel().clearSelection();
        cmbMenu.getSelectionModel().clearSelection();
        
        // Restablecer la imagen
        try {
            java.io.InputStream is = getClass().getResourceAsStream("/images/placeholder-product.png");
            if (is != null) {
                Image placeholder = new Image(is);
                if (!placeholder.isError()) {
                    imgVistaPrevia.setImage(placeholder);
                } else {
                    imgVistaPrevia.setImage(null);
                }
}
            } else {
                // Si no se encuentra el recurso, usar un ImageView vacío
                imgVistaPrevia.setImage(null);
            }
}
        } catch (Exception e) {
            // En caso de cualquier error, limpiar la imagen
            imgVistaPrevia.setImage(null);
        }
}
        lblNombreArchivo.setText("Ninguna imagen seleccionada");
        txtImagenUrl.clear();
        txtImagenPublicId.clear();
        
        // Limpiar mensajes de error
        limpiarErrores();
    }
}
    
    @FXML
    private void seleccionarImagen(ActionEvent event) {
        FileChooser fileChooser = new FileChooser();
        fileChooser.setTitle("Seleccionar imagen del producto");
        
        // Configurar filtros de extensión
        FileChooser.ExtensionFilter extFilter = new FileChooser.ExtensionFilter(
            "Archivos de imagen", "*.jpg", "*.jpeg", "*.png");
        fileChooser.getExtensionFilters().add(extFilter);
        
        // Mostrar diálogo de selección de archivo
        File archivo = fileChooser.showOpenDialog(imgVistaPrevia.getScene().getWindow());
        
        if (archivo != null) {
            try {
                // Verificar tamaño del archivo (máx 5MB)
                long fileSizeInMB = archivo.length() / (1024 * 1024);
                if (fileSizeInMB > 5) {
                    mostrarError("Error", "El archivo es demasiado grande. Tamaño máximo permitido: 5MB");
                    return;
                }
}
                
                // Cargar la imagen para previsualización
                Image imagen = new Image(archivo.toURI().toString());
                imgVistaPrevia.setImage(imagen);
                lblNombreArchivo.setText(archivo.getName());
                
                // Guardar referencia al archivo para subirlo más tarde
                imagenSeleccionada = archivo;
                
                // Limpiar campos de URL de imagen existente
                txtImagenUrl.clear();
                txtImagenPublicId.clear();
                
            } catch (Exception e) {
                e.printStackTrace();
                mostrarError("Error", "No se pudo cargar la imagen seleccionada");
            }
}
        }
}
    }
}
    
    private void subirImagen() {
        if (imagenSeleccionada == null) {
            return; // No hay imagen para subir
        }
}
        
        try {
            // Aquí iría la lógica para subir la imagen a tu servicio de almacenamiento
            // Por ejemplo, usando Cloudinary, AWS S3, o tu propio servidor
            
            // Ejemplo de cómo podría ser la implementación:
            /*
            Cloudinary cloudinary = new Cloudinary(ObjectUtils.asMap(
                "cloud_name", "tu_cloud_name",
                "api_key", "tu_api_key",
                "api_secret", "tu_api_secret"
            ));
            
            Map uploadResult = cloudinary.uploader().upload(imagenSeleccionada, 
                ObjectUtils.asMap("folder", "productos"));
                
            // Guardar la URL y el public_id de la imagen
            String imagenUrl = (String) uploadResult.get("url");
            String publicId = (String) uploadResult.get("public_id");
            
            txtImagenUrl.setText(imagenUrl);
            txtImagenPublicId.setText(publicId);
            */
            
            // Por ahora, simulamos una URL de imagen
            txtImagenUrl.setText("https://ejemplo.com/imagenes/" + imagenSeleccionada.getName());
            txtImagenPublicId.setText("productos/" + imagenSeleccionada.getName().replace(".", "_"));
            
        } catch (Exception e) {
            e.printStackTrace();
            throw new RuntimeException("Error al subir la imagen: " + e.getMessage());
        }
}
    }
}
    
    private void limpiarErrores() {
        if (lblErrorNombre != null) lblErrorNombre.setText("");
        if (lblErrorDescripcion != null) lblErrorDescripcion.setText("");
        if (lblErrorPrecio != null) lblErrorPrecio.setText("");
        if (lblErrorStock != null) lblErrorStock.setText("");
        if (lblErrorImagen != null) lblErrorImagen.setText("");
    }
}
    
    private boolean validarFormulario() {
        boolean valido = true;
        limpiarErrores();
        
        // Validar nombre
        if (txtNombre.getText() == null || txtNombre.getText().trim().isEmpty()) {
            if (lblErrorNombre != null) lblErrorNombre.setText("El nombre es requerido");
            valido = false;
        }
}
        
        // Validar descripción
        if (txtDescripcion.getText() == null || txtDescripcion.getText().trim().isEmpty()) {
            if (lblErrorDescripcion != null) lblErrorDescripcion.setText("La descripción es requerida");
            valido = false;
        }
}
        
        // Validar precio
        try {
            double precio = Double.parseDouble(txtPrecio.getText());
            if (precio <= 0) {
                if (lblErrorPrecio != null) lblErrorPrecio.setText("El precio debe ser mayor a cero");
                valido = false;
            }
}
        } catch (NumberFormatException e) {
            if (lblErrorPrecio != null) lblErrorPrecio.setText("Ingrese un precio válido");
            valido = false;
        }
}
        
        // Validar stock
        try {
            int stock = Integer.parseInt(txtStock.getText());
            if (stock < 0) {
                if (lblErrorStock != null) lblErrorStock.setText("El stock no puede ser negativo");
                valido = false;
            }
}
        } catch (NumberFormatException e) {
            if (lblErrorStock != null) lblErrorStock.setText("Ingrese una cantidad válida");
            valido = false;
        }
}
        
        return valido;
    }
}
    
    @FXML
    private void guardarProducto(ActionEvent event) {
        if (!validarFormulario()) {
            return;
        }
}
        
        try {
            // Subir la imagen si se seleccionó una nueva
            if (imagenSeleccionada != null) {
                subirImagen();
            }
}
            
            // Crear el objeto Producto
            Producto producto = new Producto();
            producto.setNombre(txtNombre.getText().trim());
            producto.setDescripcion(txtDescripcion.getText().trim());
            producto.setPrecio(Double.parseDouble(txtPrecio.getText()));
            producto.setStock(Integer.parseInt(txtStock.getText()));
            producto.setDisponible(chkDisponible.isSelected());
            
            // Si hay una categoría seleccionada, asignarla
            if (cmbCategoria.getValue() != null) {
                producto.setCategoria(cmbCategoria.getValue());
            }
}
            
            // Si hay un menú seleccionado, asignarlo
            if (cmbMenu != null && cmbMenu.getValue() != null) {
                producto.setIdMenu(cmbMenu.getValue().getId());
            }
}
            
            // Asignar URL de la imagen si existe
            if (txtImagenUrl.getText() != null && !txtImagenUrl.getText().isEmpty()) {
                producto.setImagenUrl(txtImagenUrl.getText());
                producto.setImagenPublicId(txtImagenPublicId.getText());
            }
}
            
            // Aquí iría la lógica para guardar el producto en la base de datos
            // Por ejemplo: productoService.guardarProducto(producto);
            
            // Mostrar mensaje de éxito
            mostrarMensaje("Éxito", "Producto guardado correctamente");
            
            // Cerrar la ventana
            ((Node) event.getSource()).getScene().getWindow().hide();
            
        } catch (Exception e) {
            e.printStackTrace();
            mostrarError("Error", "No se pudo guardar el producto: " + e.getMessage());
        }
}
    }
}
    
    @FXML
    private void cancelar(ActionEvent event) {
        // Mostrar confirmación si hay cambios sin guardar
        if (hayCambiosSinGuardar()) {
            Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
            alert.setTitle("Confirmar cancelación");
            alert.setHeaderText("¿Está seguro de que desea cancelar?");
            alert.setContentText("Los cambios no guardados se perderán.");
            
            Optional<ButtonType> result = alert.showAndWait();
            if (result.isPresent() && result.get() == ButtonType.OK) {
                // Cerrar la ventana
                ((Node) event.getSource()).getScene().getWindow().hide();
            }
}
        } else {
            // Cerrar la ventana directamente si no hay cambios
            ((Node) event.getSource()).getScene().getWindow().hide();
        }
}
    }
}
    
    private boolean hayCambiosSinGuardar() {
        // Verificar si hay cambios en los campos del formulario
        return (txtNombre.getText() != null && !txtNombre.getText().trim().isEmpty()) ||
               (txtDescripcion.getText() != null && !txtDescripcion.getText().trim().isEmpty()) ||
               (txtPrecio.getText() != null && !txtPrecio.getText().trim().isEmpty()) ||
               (txtStock.getText() != null && !txtStock.getText().trim().isEmpty()) ||
               imagenSeleccionada != null ||
               (txtImagenUrl.getText() != null && !txtImagenUrl.getText().isEmpty());
    }
}

    @Override
    public void initialize(URL url, ResourceBundle rb) {
        try {
            // Configurar el ComboBox de menús
            configurarComboMenus();
            
            // Agregar listener para cambios en la selección del menú solo si el ComboBox existe
            if (cmbMenu != null) {
                cmbMenu.getSelectionModel().selectedItemProperty().addListener((obs, oldVal, newVal) -> {
                    if (newVal != null) {
                        menuId = newVal.getId();
                    } else {
                        menuId = null;
                    }
}
                    cargarProductos();
                });
            }
}
            // Configurar las columnas de la tabla si existen
            if (colNombre != null) {
                colNombre.setCellValueFactory(new PropertyValueFactory<>("nombre"));
            }
}
            if (colDescripcion != null) {
                colDescripcion.setCellValueFactory(new PropertyValueFactory<>("descripcion"));
            }
}
            if (colPrecio != null) {
                colPrecio.setCellValueFactory(new PropertyValueFactory<>("precioFormateado"));
            }
}
            if (colDisponible != null) {
                colDisponible.setCellValueFactory(new PropertyValueFactory<>("disponible"));
            }
}
            
            // Configurar la columna de acciones si existe
            if (colAcciones != null) {
                colAcciones.setCellFactory(param -> new TableCell<Producto, Void>() {
                    private final Button btnEditar = new Button("Editar");
                    private final Button btnEliminar = new Button("Eliminar");
                    private final HBox botones = new HBox(5, btnEditar, btnEliminar);
                    
                    {
                        btnEditar.getStyleClass().add("btn-editar");
                        btnEliminar.getStyleClass().add("btn-eliminar");
                        
                        btnEditar.setOnAction(event -> {
                            Producto producto = getTableView().getItems().get(getIndex());
                            editarProducto(producto);
                        });
                        
                        btnEliminar.setOnAction(event -> {
                            Producto producto = getTableView().getItems().get(getIndex());
                            confirmarEliminacion(producto);
                        });
                    }
}
                    
                    @Override
                    protected void updateItem(Void item, boolean empty) {
                        super.updateItem(item, empty);
                        if (empty) {
                            setGraphic(null);
                        } else {
                            setGraphic(botones);
                        }
}
                    }
}
                });
            }
}
            
            // Configurar el listener de búsqueda si el campo de búsqueda existe
            if (txtBuscar != null) {
                txtBuscar.textProperty().addListener((obs, oldVal, newVal) -> buscarProductos());
            }
}
            
            // Cargar datos iniciales
            cargarProductos();
        } catch (Exception e) {
            e.printStackTrace();
            AlertUtils.mostrarError("Error", "Error al inicializar la vista de productos: " + e.getMessage());
        }
}
    }
}

    @FXML
    private void buscarProductos() {
        paginaActual = 0; // Resetear a la primera página al realizar una nueva búsqueda
        actualizarVistaProductos();
    }
}
    
    @FXML
    private void limpiarBusqueda() {
        txtBuscar.clear();
        if (cmbMenu != null && cmbMenu.getItems() != null && !cmbMenu.getItems().isEmpty()) {
            cmbMenu.getSelectionModel().select(0); // Seleccionar "Todos los menús"
        }
}
        cargarProductos();
    }
}
    

    
    /**
     * Limpia los recursos cuando el controlador ya no se usa
     */
    public void limpiarRecursos() {
        try {
            imageCache.clear();
            productos.clear();
        } catch (Exception e) {
            System.err.println("Error al limpiar recursos: " + e.getMessage());
        }
}
    }
}

    private Predicate<Producto> crearPredicadoBusqueda(String busqueda, String categoria, String disponibilidad) {
        return producto -> {
            if (producto == null) return false;
            
            // Filtrar por búsqueda
            boolean coincideBusqueda = busqueda == null || busqueda.isEmpty() ||
                (producto.getNombre() != null && producto.getNombre().toLowerCase().contains(busqueda.toLowerCase())) ||
                (producto.getDescripcion() != null && 
                 producto.getDescripcion().toLowerCase().contains(busqueda.toLowerCase()));

            // Filtrar por categoría
            boolean coincideCategoria = categoria == null || 
                categoria.isEmpty() ||
                categoria.equals("Todas las categorías") ||
                (producto.getCategoria() != null && 
                 producto.getCategoria().equalsIgnoreCase(categoria));

            // Filtrar por disponibilidad
            boolean coincideDisponibilidad = true;
            if (disponibilidad != null && !disponibilidad.isEmpty()) {
                if (disponibilidad.equals("Disponibles")) {
                    coincideDisponibilidad = producto.getDisponible() != null && producto.getDisponible();
                } else if (disponibilidad.equals("No disponibles")) {
                    coincideDisponibilidad = producto.getDisponible() == null || !producto.getDisponible();
                }
}
            }
}

            return coincideBusqueda && coincideCategoria && coincideDisponibilidad;
        };
    }
}

    @FXML
    public void nuevoProducto() {
        handleAgregarProducto((ActionEvent) null);
    }
}
    
    @FXML
    private void handleAgregarProducto() {
        try {
            // Cargar el FXML simplificado
            FXMLLoader loader = new FXMLLoader(
                getClass().getResource("/views/gerencia/productos/formulario_producto_simple.fxml")
            );
            
            // Cargar el panel del diálogo
            DialogPane dialogPane = loader.load();
            
            // Obtener referencias a los campos del formulario
            TextField txtNombre = (TextField) dialogPane.lookup("#txtNombre");
            
            // Configurar el diálogo
            Dialog<ButtonType> dialog = new Dialog<>();
            dialog.setDialogPane(dialogPane);
            dialog.setTitle("Nuevo Producto");
            
            // Configurar el botón de guardar
            ButtonType guardarButtonType = new ButtonType("Guardar", ButtonBar.ButtonData.OK_DONE);
            dialog.getDialogPane().getButtonTypes().addAll(guardarButtonType, ButtonType.CANCEL);
            
            // Validar antes de cerrar
            dialog.setResultConverter(buttonType -> {
                if (buttonType == guardarButtonType) {
                    // Validación simple del formulario
                    if (txtNombre.getText() == null || txtNombre.getText().trim().isEmpty()) {
                        Alert alert = new Alert(Alert.AlertType.ERROR);
                        alert.setTitle("Error");
                        alert.setHeaderText(null);
                        alert.setContentText("El nombre del producto es obligatorio");
                        alert.showAndWait();
                        return null;
                    }
}
                    return buttonType;
                }
}
                return buttonType;
            });
            
            // Mostrar el diálogo y procesar el resultado
            Optional<ButtonType> result = dialog.showAndWait();
            if (result.isPresent() && result.get() == guardarButtonType) {
                // Crear y guardar el nuevo producto
                Producto producto = new Producto();
                producto.setNombre(txtNombre.getText().trim());
                
                // Ejecutar en un hilo separado
                Task<Boolean> tareaGuardar = new Task<Boolean>() {
                    @Override
                    protected Boolean call() throws Exception {
                        Producto creado = productoService.crear(producto);
                        return creado != null && creado.getId() != null;
                    }
}
                };
                
                tareaGuardar.setOnSucceeded(_evt -> {
                    if (tareaGuardar.getValue()) {
                        Platform.runLater(() -> {
                            Alert alert = new Alert(Alert.AlertType.INFORMATION);
                            alert.setTitle("Éxito");
                            alert.setHeaderText(null);
                            alert.setContentText("Producto guardado correctamente");
                            alert.showAndWait();
                            cargarProductos();
                        });
                    }
}
                });
                
                tareaGuardar.setOnFailed(_evt -> {
                    Platform.runLater(() -> {
                        Alert alert = new Alert(Alert.AlertType.ERROR);
                        alert.setTitle("Error");
                        alert.setHeaderText(null);
                        alert.setContentText("Error al guardar el producto: " + 
                            (tareaGuardar.getException() != null ? 
                                tareaGuardar.getException().getMessage() : "Error desconocido"));
                        alert.showAndWait();
                    });
                });
                
                new Thread(tareaGuardar).start();
            }
}
            
        } catch (IOException e) {
            e.printStackTrace();
            Alert alert = new Alert(Alert.AlertType.ERROR);
            alert.setTitle("Error");
            alert.setHeaderText(null);
            alert.setContentText("No se pudo cargar el formulario: " + e.getMessage());
            alert.showAndWait();
        }
}
    }
}

    private void confirmarEliminacion(Producto producto) {
        if (producto == null) return;
        
        // Mostrar diálogo de confirmación
        Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
        alert.setTitle("Confirmar eliminación");
        alert.setHeaderText(null);
        alert.setContentText("¿Está seguro de que desea eliminar el producto '" + 
            producto.getNombre() + "'?\nEsta acción no se puede deshacer.");
        
        // Mostrar diálogo y esperar respuesta
        alert.showAndWait().ifPresent(buttonType -> {
            if (buttonType == ButtonType.OK) {
                mostrarCargando(true);
                
                Task<Boolean> tareaEliminar = new Task<>() {
                    @Override
                    protected Boolean call() throws Exception {
                        return productoService.eliminar(producto.getId());
                    }
}
                };
                
                tareaEliminar.setOnSucceeded(_ -> {
                    mostrarCargando(false);
                    if (tareaEliminar.getValue()) {
                        // Eliminación exitosa, actualizar la vista
                        Platform.runLater(() -> {
                            productos.remove(producto);
                            actualizarVistaProductos();
                            AlertUtils.mostrarInformacion("Éxito", "Producto eliminado correctamente");
                        });
                    } else {
                        Platform.runLater(() -> 
                            AlertUtils.mostrarError("Error", "No se pudo eliminar el producto")
                        );
                    }
}
                });
                
                tareaEliminar.setOnFailed(_ -> {
                    mostrarCargando(false);
                    Platform.runLater(() -> 
                        AlertUtils.mostrarError("Error", "Error al intentar eliminar el producto: " + 
                            (tareaEliminar.getException() != null ? 
                                tareaEliminar.getException().getMessage() : "Error desconocido"))
                    );
                });
                
                new Thread(tareaEliminar).start();
            }
}
        });
    }
}

    private void editarProducto(Producto producto) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/views/gerencia/productos/formulario_producto.fxml"));
            Parent root = loader.load();
            
            ProductoFormController formController = loader.getController();
            formController.setProductoService(productoService);
            formController.setProducto(producto);
            
            Dialog<ButtonType> dialog = new Dialog<>();
            dialog.setTitle("Editar Producto: " + producto.getNombre());
            dialog.getDialogPane().setContent(root);
            dialog.getDialogPane().getButtonTypes().addAll(ButtonType.OK, ButtonType.CANCEL);
            
            Button okButton = (Button) dialog.getDialogPane().lookupButton(ButtonType.OK);
            okButton.setText("Guardar");
            
            BooleanProperty formularioValido = formController.getFormularioValidoProperty();
            if (formularioValido != null) {
                okButton.disableProperty().bind(formularioValido.not());
            }
}
            
            dialog.showAndWait().ifPresent(buttonType -> {
                if (buttonType == ButtonType.OK) {
                    Task<Boolean> tareaActualizar = new Task<>() {
                        @Override
                        protected Boolean call() throws Exception {
                            formController.guardar();
                            return true;
                        }
}
                    };
                    
                    tareaActualizar.setOnSucceeded(_ -> {
                        cargarProductos(); // Recargar la lista de productos
                    });
                    
                    tareaActualizar.setOnFailed(_ -> {
                        Throwable ex = tareaActualizar.getException();
                        AlertUtils.mostrarError("Error", "No se pudo actualizar el producto: " + 
                            (ex != null ? ex.getMessage() : "Error desconocido"));
                    });
                    
                    new Thread(tareaActualizar).start();
                }
}
            });
            
        } catch (IOException e) {
            e.printStackTrace();
            AlertUtils.mostrarError("Error", 
                "No se pudo abrir el formulario de edición: " + e.getMessage());
        }
}
    }
}

    private void configurarComboMenus() {
        // Si no hay un ComboBox de menú, no hacemos nada
        if (cmbMenu == null) {
            return;
        }
}
        
        // Obtener el ID del local actual del usuario logueado
        final Long idLocal;
        Usuario usuarioActual = AuthService.getInstance().getCurrentUser();
        if (usuarioActual != null) {
            idLocal = usuarioActual.getIdLocalAsignado();
        } else {
            idLocal = null;
        }
}
        
        Task<List<Menu>> tarea = new Task<>() {
            @Override
            protected List<Menu> call() throws Exception {
                // Agregar una opción para mostrar todos los menús
                Menu todos = new Menu();
                todos.setId(null);
                todos.setNombre("Todos los menús");
                
                List<Menu> menus = new ArrayList<>();
                menus.add(todos);
                
                if (idLocal != null) {
                    // Obtener solo los menús del local actual
                    menus.addAll(menuService.obtenerPorLocal(idLocal));
                } else {
                    // Si no hay local asignado, obtener todos los menús
                    menus.addAll(menuService.obtenerTodos());
                }
}
                
                return menus;
            }
}
        };

        tarea.setOnSucceeded(e -> {
            try {
                List<Menu> menus = tarea.getValue();
                if (cmbMenu != null) {
                    cmbMenu.getItems().setAll(menus);
                    
                    // Seleccionar la opción por defecto (todos los menús)
                    if (!menus.isEmpty()) {
                        cmbMenu.getSelectionModel().select(0);
                    }
}
                }
}
            } catch (Exception ex) {
                mostrarError("Error", "No se pudieron cargar los menús: " + ex.getMessage());
                ex.printStackTrace();
            }
}
        });

        tarea.setOnFailed(e -> {
            if (cmbMenu != null) {
                mostrarError("Error", "Error al cargar los menús: " + tarea.getException().getMessage());
            }
}
            tarea.getException().printStackTrace();
        });

        new Thread(tarea).start();
    }
}
    
    private void cargarProductos() {
        mostrarCargando(true);
        
        Task<List<Producto>> tarea = new Task<>() {
            @Override
            protected List<Producto> call() throws Exception {
                if (menuId != null) {
                    return productoService.obtenerProductosPorMenu(menuId);
                } else {
                    return productoService.obtenerTodos();
                }
}
            }
}
            
            @Override
            protected void succeeded() {
                try {
                    List<Producto> resultado = get();
                    if (resultado != null) {
                        productos.setAll(resultado);
                        totalProductos = productos.size();
                        actualizarVistaProductos();
                    }
}
                } catch (Exception e) {
                    e.printStackTrace();
                    AlertUtils.mostrarError("Error", "Error al cargar los productos: " + e.getMessage());
                } finally {
                    mostrarCargando(false);
                }
}
            }
}
            
            @Override
            protected void failed() {
                Throwable e = getException();
                e.printStackTrace();
                AlertUtils.mostrarError("Error", "Error al cargar los productos: " + e.getMessage());
                mostrarCargando(false);
            }
}
        };
        
        new Thread(tarea).start();
    }
}

    /**
     * Muestra u oculta el indicador de carga
     */
    private void mostrarError(String titulo, String mensaje) {
        Platform.runLater(() -> {
            Alert alert = new Alert(Alert.AlertType.ERROR);
            alert.setTitle(titulo);
            alert.setHeaderText(null);
            alert.setContentText(mensaje);
            alert.showAndWait();
        });
    }
}
    
    /**
     * Muestra un mensaje informativo al usuario
     * @param titulo El título del mensaje
     * @param mensaje El contenido del mensaje
     */
    private void mostrarMensaje(String titulo, String mensaje) {
        Platform.runLater(() -> {
            Alert alert = new Alert(Alert.AlertType.INFORMATION);
            alert.setTitle(titulo);
            alert.setHeaderText(null);
            alert.setContentText(mensaje);
            alert.showAndWait();
        });
    }
}
    
    private void mostrarCargando(boolean mostrar) {
        if (loadingPane != null) {
            loadingPane.setVisible(mostrar);
            loadingPane.setManaged(mostrar);
        }
}
    }
}

    /**
     * Actualiza los controles de paginación
     */
    private void actualizarControlesPaginacion() {
        if (lblPagina != null) {
            int totalPaginas = (int) Math.ceil((double) productos.size() / ITEMS_POR_PAGINA);
            int paginaMostrada = totalProductos > 0 ? paginaActual + 1 : 0;
            lblPagina.setText(String.format("Página %d de %d", paginaMostrada, Math.max(1, totalPaginas)));
        }
}
    }
}

    /**
     * Navega a la página anterior
     */
    @FXML
    private void paginaAnterior() {
        if (paginaActual > 0) {
            paginaActual--;
            actualizarVistaProductos();
        }
}
    }
}

    /**
     * Navega a la página siguiente
     */
    @FXML
    private void paginaSiguiente() {
        int totalPaginas = (int) Math.ceil((double) productos.size() / ITEMS_POR_PAGINA);
        if (paginaActual < totalPaginas - 1) {
            paginaActual++;
            actualizarVistaProductos();
        }
}
    }
}
    
    /**
     * Actualiza la vista de productos aplicando los filtros de búsqueda y paginación
     */
    private void actualizarVistaProductos() {
        try {
            // Obtener el texto de búsqueda de forma segura
            String textoBusqueda = txtBuscar != null ? txtBuscar.getText() : "";
            
            // Filtrar productos basados en el texto de búsqueda
            List<Producto> productosFiltrados = productos.stream()
                .filter(Objects::nonNull)
                .filter(p -> p.getNombre() != null && 
                           p.getNombre().toLowerCase().contains(textoBusqueda.toLowerCase()))
                .collect(Collectors.toList());
            
            // Actualizar el contador total de productos
            totalProductos = productosFiltrados.size();
            
            // Calcular la paginación
            int fromIndex = paginaActual * ITEMS_POR_PAGINA;
            int toIndex = Math.min(fromIndex + ITEMS_POR_PAGINA, totalProductos);
            
            // Obtener la sublista para la página actual
            List<Producto> productosPagina = productosFiltrados.subList(
                fromIndex, 
                Math.min(toIndex, productosFiltrados.size())
            );
            
            // Actualizar la tabla en el hilo de la aplicación JavaFX
            Platform.runLater(() -> {
                try {
                    if (tblProductos != null) {
                        // Limpiar elementos existentes y agregar los filtrados
                        tblProductos.getItems().clear();
                        if (!productosPagina.isEmpty()) {
                            tblProductos.getItems().addAll(productosPagina);
                        }
}
                    }
}
                    // Actualizar controles de paginación
                    actualizarControlesPaginacion();
                } catch (Exception e) {
                    e.printStackTrace();
                    AlertUtils.mostrarError("Error", "Error al actualizar la tabla: " + e.getMessage());
                } finally {
                    mostrarCargando(false);
                }
}
            });
            
        } catch (Exception e) {
            e.printStackTrace();
            AlertUtils.mostrarError("Error", "Error al filtrar productos: " + e.getMessage());
            mostrarCargando(false);
        }
}
    }
}
